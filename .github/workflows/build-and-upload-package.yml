name: Package/Upload

run-name: 'Package: ${{ github.ref_name }}_${{ github.run_id }}_${{ github.run_attempt }}'

on:
  push:
    branches: ['master']
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  actions: write

jobs:
  package:
    runs-on: ubuntu-latest

    outputs:
      build-number: ${{ steps.package-default-version.outputs.version }}

    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: List files and directories for debug
        run: |
          echo "Listing root directory contents:"
          ls -l
          echo "Listing cloudformation directory contents:"
          ls -l cloudformation || echo "cloudformation directory not found"
          echo "Listing forge-files directory contents:"
          ls -l forge-files || echo "forge-files directory not found"

      - id: package-default-version
        name: Get Default Version outputs
        run: echo "::set-output name=version::$(date +'%Y%m%d%H%M%S')"

      - id: package-create
        name: Package
        run: |
          mkdir -p package
          [ -d cloudformation ] && cp -r cloudformation package/
          [ -d forge-files ] && cp -r forge-files package/
          [ -d container ] && cp -r container package/
          [ -d generated_data ] && cp -r generated_data package/
          [ -f README.md ] && cp README.md package/
          cd package
          zip -r ../${{ steps.package-default-version.outputs.version }}.zip ./
          cd ..

      - id: package-upload
        name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package-default-version.outputs.version }}
          path: ${{ steps.package-default-version.outputs.version }}.zip
